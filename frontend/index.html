<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Chat</title>
  <link rel="icon" href="data:,">
</head>
<body>
<textarea id="chat" rows="10" cols="50"></textarea><br>
<input id="msg"/><button id="send">Send</button>
<script src="lib/ipfs-http-client.min.js"></script>
<script src="lib/orbitdb.min.js"></script>
<script type="module">
const { create } = IpfsHttpClient;
const { createOrbitDB } = OrbitDB;
const ipfs = create({ url: 'http://localhost:5001' });
const id = await ipfs.id();
ipfs.libp2p = {
  peerId: { toString: () => id.id },
  services: {
    pubsub: {
      subscribe: (...a) => ipfs.pubsub.subscribe(...a),
      unsubscribe: (...a) => ipfs.pubsub.unsubscribe(...a),
      publish: (...a) => ipfs.pubsub.publish(...a)
    }
  }
};
const orbitdb = await createOrbitDB({ ipfs });
const res = await fetch('http://localhost:3000/address');
const { address } = await res.json();
const db = await orbitdb.open(address);
await db.sync();
function render() {
  document.getElementById('chat').value = (await db.all()).map(e=>e.text).join('\n');
}
db.events.on('update', render);
render();
document.getElementById('send').onclick = async () => {
  const text = document.getElementById('msg').value;
  await fetch('http://localhost:3000/messages', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ text })
  });
  document.getElementById('msg').value = '';
};
</script>
</body>
</html>
